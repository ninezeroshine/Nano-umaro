# Контекст проекта GEMINI: Nano-Generator

Этот документ представляет собой всеобъемлющий обзор проекта "Nano Generator", его структуры и соглашений, которые будут направлять будущую разработку.

## 1. Обзор проекта

**Nano Generator** — это full-stack веб-приложение, предназначенное для генерации изображений с использованием Google Vertex AI (в частности, модели Gemini 2.5 Flash Image Preview). Оно предоставляет минималистичный и эффективный интерфейс для генерации как из текста в изображение (text-to-image), так и из изображения в изображение (image-to-image).

**Ключевые технологии:**

*   **Бэкенд:** Сервер на Node.js, созданный с помощью **Fastify** и написанный на **TypeScript**. Он действует как безопасный прокси к API Google Vertex AI, обрабатывая аутентификацию, очередность запросов, управление ошибками и кэширование сгенерированных изображений.
*   **Фронтенд:** Современный пользовательский интерфейс, созданный с помощью **React** и **TypeScript**, использующий **Vite** для сервера разработки и сборки. Он использует `@tanstack/react-query` для управления состоянием сервера и взаимодействия с API.
*   **Структура в стиле Monorepo:** Проект организован в две основные директории, `frontend/` и `backend/`, каждая со своим собственным файлом `package.json` и зависимостями.

## 2. Сборка и запуск

Проект спроектирован для простого процесса запуска, особенно в Windows.

### Рекомендуемый способ: `start-nano.cmd`

Самый простой способ запустить полную среду разработки — это выполнить скрипт `start-nano.cmd`, расположенный в корне проекта.

Этот скрипт автоматизирует следующие шаги:
1.  **Установка зависимостей:** Проверяет наличие `node_modules` в директориях `backend/` и `frontend/` и выполняет `npm install`, если они отсутствуют.
2.  **Запуск бэкенд-сервера:** Открывает новое окно терминала с именем "Nano Backend" и выполняет `npm run dev` для запуска сервера Fastify на `http://localhost:3000`. Для корректного отображения кириллицы в логах кодовая страница терминала автоматически меняется на UTF-8 (`chcp 65001`).
3.  **Запуск фронтенд-сервера:** Открывает еще одно окно терминала с именем "Nano Frontend" и выполняет `npm run dev` для запуска сервера разработки Vite.
4.  **Открытие браузера:** Автоматически открывает ваш веб-браузер по умолчанию и переходит к приложению по адресу `http://127.0.0.1:5173`.

### Ручной запуск

В качестве альтернативы вы можете запустить фронтенд и бэкенд серверы вручную в отдельных терминалах:

*   **Бэкенд:**
    ```bash
    cd backend
    npm install # Если запускаете впервые
    npm run dev
    ```

*   **Фронтенд:**
    ```bash
    cd frontend
    npm install # Если запускаете впервые
    npm run dev
    ```

### Сборка для продакшена

Для сборки готовых к развертыванию ассетов:

*   **Бэкенд:** `cd backend && npm run build` (компилирует TypeScript в директорию `dist/`).
*   **Фронтенд:** `cd frontend && npm run build` (создает продакшен-сборку в директории `dist/`).

## 3. Соглашения по разработке

### Конфигурация

*   **Конфигурация бэкенда (`backend/.env`):** Пары ключ-значение для бэкенд-сервера, включая `PORT`, `IMAGE_MODEL` и `REQUEST_TIMEOUT_MS`.
*   **Учетные данные Google Cloud (`vertex-ai-key.json`):** Обязательный файл с JSON-ключом для сервисного аккаунта Google Cloud должен быть размещен в корне проекта. Этот файл добавлен в `.gitignore` и не должен попадать в коммиты.

### API бэкенда

Бэкенд предоставляет простой REST API, который использует фронтенд:

*   `POST /api/generate`: Основная конечная точка для генерации изображений. Принимает тело запроса в формате JSON с полями `prompt`, `n` (количество изображений), `mode` ('text-to-image' или 'image-to-image') и необязательным `imageDataUrls` (массив строк) для задач image-to-image.
*   `GET /api/gallery`: Возвращает список ранее сгенерированных и кэшированных изображений.

### Архитектура и стиль фронтенда

Реализация фронтенда руководствуется подробной технической спецификацией в файле `style_rule.md`. Этот файл следует считать источником истины для UI/UX, дизайна компонентов и контрактов API.

*   **Структура компонентов:**
    *   `AppShell.tsx`: Основной компонент макета. Управляет состоянием приложения, включая `mode`, `prompt`, `aspectRatio` и `canvasColor`. Передает состояние и обработчики в `RightPanel` и инициирует генерацию изображений.
    *   `RightPanel.tsx`: Содержит все элементы управления для генерации (переключатель режима, промпт, область для перетаскивания изображений и т.д.). Включает в себя раскрывающуюся секцию для выбора соотношения сторон и цвета холста, который может быть добавлен к генерации.
    *   `Gallery.tsx`: Отображает сетку сгенерированных изображений.
*   **Управление состоянием:** Состояние сервера (запросы к API, кэширование и т.д.) обрабатывается с помощью `@tanstack/react-query`. Основным хуком для генерации изображений является `useGenerate`.
*   **Клиент API:** Логика взаимодействия с API централизована в `frontend/src/ui2/api/`.
*   **Типы:** Типы TypeScript для запросов и ответов API определены в `frontend/src/ui2/types/`.
